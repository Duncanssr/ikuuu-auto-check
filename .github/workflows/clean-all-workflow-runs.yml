name: 每月清理工作流记录

于:
  schedule:
    - cron: '0 0 1 * *'  # 每月1日执行
  workflow_dispatch:

jobs:
  clean-runs:
    runs-on: ubuntu-latest
    permissions:
      actions: write

    steps:
      - name: 清理所有工作流记录
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          echo "开始清理仓库 $REPO 的所有工作流记录..."
          
          WORKFLOW_IDS=$(gh api -X GET /repos/$REPO/actions/workflows | jq -r '.workflows[] | .id')
          
          for WORKFLOW_ID in $WORKFLOW_IDS; do
            echo "处理工作流 ID: $WORKFLOW_ID"
            PAGE=1
            while true; do
              RUNS=$(gh api -X GET "/repos/$REPO/actions/workflows/$WORKFLOW_ID/runs?page=$PAGE&per_page=100" | jq -r '.workflow_runs[] | .id')
              
              if [ -z "$RUNS" ]; then
                break
              fi
              
              for RUN_ID in $RUNS; do
                echo "删除工作流记录 ID: $RUN_ID"
                gh api -X DELETE "/repos/$REPO/actions/runs/$RUN_ID"
                sleep 1
              done
              
              PAGE=$((PAGE + 1))
            done
          done
          
          echo "✅ 所有工作流记录已清理完成"
