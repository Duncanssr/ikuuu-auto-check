name: æ¯æœˆå…¨é‡æ¸…ç†å·¥ä½œæµè®°å½•

on:
  schedule:
    - cron: '0 0 1 * *'  # æ¯æœˆ1æ—¥UTC 0ç‚¹è‡ªåŠ¨æ‰§è¡Œ
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  clean-all-runs:
    runs-on: ubuntu-latest
    permissions:
      actions: write      # å¿…éœ€ï¼šåˆ é™¤å·¥ä½œæµè®°å½•çš„æƒé™
      contents: read
    env:
      REPO: ${{ github.repository }}
      CURRENT_RUN_ID: ${{ github.run_id }}
      GH_PAT: ${{ secrets.GH_PAT }}   # å¦‚æœæ²¡è®¾ç½®ï¼Œä¼šæ˜¯ç©º

    steps:
      - name: æ¸…ç†æ‰€æœ‰å·¥ä½œæµè®°å½•
        run: |
          TOKEN=${GH_PAT:-${{ github.token }}}
          echo "ğŸ“¦ å¼€å§‹æ¸…ç†ä»“åº“ $REPO çš„å·¥ä½œæµè®°å½•ï¼ˆå½“å‰ä»»åŠ¡ID: $CURRENT_RUN_IDï¼‰"

          WORKFLOW_IDS=$(curl -s -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/actions/workflows" \
            | jq -r '.workflows[]?.id')

          if [ -z "$WORKFLOW_IDS" ]; then
            echo "âš ï¸ æœªè·å–åˆ°å·¥ä½œæµIDï¼Œä»“åº“å¯èƒ½æ²¡æœ‰å·¥ä½œæµ"
            exit 0
          fi

          for WORKFLOW_ID in $WORKFLOW_IDS; do
            echo -e "\n=== ğŸ”„ å¤„ç†å·¥ä½œæµ ID: $WORKFLOW_ID ==="
            PAGE=1
            while true; do
              echo -n "ğŸ“„ è·å–ç¬¬ $PAGE é¡µè®°å½•..."
              RUNS=$(curl -s -H "Authorization: Bearer $TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_ID/runs?page=$PAGE&per_page=100" \
                | jq -r --arg CURRENT_ID "$CURRENT_RUN_ID" '.workflow_runs[]? | select(.id != ($CURRENT_ID|tonumber)) | .id')

              if [ -z "$RUNS" ]; then
                echo " æ— æ›´å¤šè®°å½•"
                break
              fi

              echo " å…±æ‰¾åˆ° $(echo "$RUNS" | wc -l) æ¡å¾…åˆ é™¤è®°å½•"
              for RUN_ID in $RUNS; do
                echo -n "ğŸ—‘ï¸ åˆ é™¤è®°å½• ID: $RUN_ID ... "
                STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
                  -H "Authorization: Bearer $TOKEN" \
                  -H "Accept: application/vnd.github+json" \
                  "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID")

                if [ "$STATUS" -eq 204 ]; then
                  echo "âœ… æˆåŠŸ"
                else
                  echo "âŒ å¤±è´¥ (HTTP $STATUS)"
                fi
              done

              PAGE=$((PAGE+1))
              sleep 1
            done
          done

          echo -e "\nğŸ‰ æ‰€æœ‰å¯åˆ é™¤çš„å·¥ä½œæµè®°å½•å·²å¤„ç†å®Œæˆ"
